{% extends "base.html" %}

{% block title %}OCR Editor - File Browser{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-home"></i> OCR Editor Dashboard</h2>
            <div id="projectStats" class="text-end">
                <!-- Project stats will be loaded here -->
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Welcome</h5>
                    </div>
                    <div class="card-body">
                        <p>Use the sidebar to navigate through your folders and pages. The sidebar shows:</p>
                        <ul>
                            <li><strong>All folders</strong> with page counts and validation status</li>
                            <li><strong>Individual pages</strong> within each folder</li>
                            <li><strong>Validation indicators</strong> (green checkmarks for validated pages)</li>
                        </ul>
                        
                        <p>Click on any page in the sidebar to start editing. The sidebar persists across all pages for easy navigation.</p>
                        
                        <div class="mt-3">
                            <h6>Quick Actions:</h6>
                            <button class="btn btn-primary me-2" onclick="exportProject()">
                                <i class="fas fa-download"></i> Export Entire Project
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="toggleSidebar()">
                                <i class="fas fa-eye-slash"></i> Toggle Sidebar
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearDatabase()">
                                <i class="fas fa-database"></i> Clear Database
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Clear database if you moved data between Mac/Windows or changed the data directory.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Upload Files</h5>
                    </div>
                    <div class="card-body">
                        <div class="file-drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                            <h6>Drop files here</h6>
                            <p class="text-muted small">or click to select</p>
                            <input type="file" id="fileInput" multiple accept=".json,.png,.jpg,.jpeg" style="display: none;">
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                Upload both JSON and image files together. 
                                Supported formats: PNG, JPG, JPEG
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading d-none" id="loadingDiv">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading file...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load project stats on page load
$(document).ready(function() {
    loadDashboardStats();
});

function loadDashboardStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.total_pages > 0) {
                const progressPercentage = data.validation_percentage;
                const progressColor = progressPercentage >= 80 ? 'success' : 
                                    progressPercentage >= 50 ? 'warning' : 'danger';
                
                const statsHtml = `
                    <div>
                        <h5 class="mb-1">${data.total_pages} Total Pages</h5>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-${progressColor}" style="width: ${progressPercentage}%">
                                ${data.validated_pages} validated (${progressPercentage}%)
                            </div>
                        </div>
                        <small class="text-muted">
                            ${data.folder_stats.length} folders • 
                            ${data.validated_pages} validated • 
                            ${data.total_pages - data.validated_pages} remaining
                        </small>
                    </div>
                `;
                $('#projectStats').html(statsHtml);
            } else {
                $('#projectStats').html('<small class="text-muted">No pages found</small>');
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            $('#projectStats').html('<small class="text-danger">Error loading stats</small>');
        });
}

function exportFolder(folderName) {
    fetch('/api/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            export_type: 'folder',
            export_scope: folderName
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `folder_${folderName}_${new Date().toISOString().slice(0,19).replace(/:/g, '')}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        alert('Error exporting folder: ' + error.message);
    });
}

function exportProject() {
    fetch('/api/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            export_type: 'project'
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `entire_project_${new Date().toISOString().slice(0,19).replace(/:/g, '')}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        alert('Error exporting project: ' + error.message);
    });
}

function clearDatabase() {
    if (!confirm('Are you sure you want to clear the database? This will remove all cached page data and validation status. Original files will not be affected.')) {
        return;
    }
    
    fetch('/api/clear_database', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error clearing database: ' + data.error);
        } else {
            alert('Database cleared successfully! The page will now reload.');
            window.location.reload();
        }
    })
    .catch(error => {
        alert('Error clearing database: ' + error.message);
    });
}

function loadFile(jsonPath, imagePath) {
    document.getElementById('loadingDiv').classList.remove('d-none');
    
    const params = new URLSearchParams({
        json_path: jsonPath,
        image_path: imagePath
    });
    window.location.href = '/editor?' + params.toString();
}

let uploadedFiles = {json: null, image: null};

// File drop zone functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
});
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    uploadedFiles = {json: null, image: null};
    
    Array.from(files).forEach(file => {
        if (file.name.endsWith('.json')) {
            uploadedFiles.json = file;
        } else if (file.name.match(/\.(png|jpg|jpeg)$/i)) {
            uploadedFiles.image = file;
        }
    });
    
    if (uploadedFiles.json && uploadedFiles.image) {
        uploadFiles();
    } else {
        alert('Please upload both a JSON file and an image file.');
    }
}

function uploadFiles() {
    const formData = new FormData();
    formData.append('json_file', uploadedFiles.json);
    formData.append('image_file', uploadedFiles.image);
    
    document.getElementById('loadingDiv').classList.remove('d-none');
    
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingDiv').classList.add('d-none');
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Redirect to editor with uploaded files
            const params = new URLSearchParams({
                json_path: data.json_path,
                image_path: data.image_path,
                uploaded: 'true'
            });
            window.location.href = '/editor?' + params.toString();
        }
    })
    .catch(error => {
        document.getElementById('loadingDiv').classList.add('d-none');
        alert('Error uploading files: ' + error);
    });
}
</script>
{% endblock %}
